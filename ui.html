<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>figma2dezerv</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@600&family=Fira+Code:wght@500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-primary: #101112;
        --bg-secondary: #1b1d1e;
        --bg-tertiary: #26282a;
        --text-primary: #fcfeff;
        --text-disabled: #63676a;
        --text-action: #101112;
        --accent: #93bc63;
      }
      html, body {
        margin: 0;
        padding: 0;
        width: 640px;
        height: 480px;
        background: var(--bg-primary);
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol";
      }
      .app { position: relative; width: 640px; height: 480px; background: var(--bg-primary); overflow: hidden; }

      /* Sidebar */
      .sidebar { position: absolute; left: 0; top: 0; width: 200px; height: 480px; background: var(--bg-secondary); }
      .sidebar__title { color: var(--text-primary); font-weight: 600; font-size: 20px; letter-spacing: -0.4px; line-height: 24px; margin: 20px 0 0 20px; }
      .sidebar__select { position: absolute; left: 50%; transform: translateX(-50%); width: 160px; height: 36px; border-radius: 8px; border: 1px solid #494c4f; background: #1b1d1e; color: #fcfeff; padding: 0 8px; font-size: 14px; }

      /* Main content */
      .content { position: absolute; right: 0; top: 0; width: 440px; height: 480px; }
      .code { position: absolute; right: 20px; bottom: 76px; width: 400px; height: 336px; background: var(--bg-secondary); border-radius: 4px; padding: 8px; overflow: auto; }
      .code__pre { margin: 0; font-family: "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; line-height: 16px; font-weight: 500; color: var(--accent); }

      .actions { position: absolute; right: 20px; bottom: 20px; display: flex; gap: 8px; }
      .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
      .toast { position: absolute; left: 50%; bottom: 72px; transform: translateX(-50%); background: #26282a; color: #fcfeff; padding: 6px 10px; border-radius: 6px; font-size: 12px; opacity: 0; transition: opacity 160ms ease-in-out; pointer-events: none; }
      .toast--show { opacity: 1; }
      .btn { height: 36px; padding: 8px 16px; border-radius: 8px; border: 0; font-weight: 600; font-size: 16px; letter-spacing: -0.24px; display: inline-flex; align-items: center; justify-content: center; }
      .btn--primary { background: #fcfeff; color: #101112; }
      .btn--secondary { background: #26282a; color: #fcfeff; }
      .btn--copy { width: 72px; }
      .btn--download { width: 108px; }
      .btn--download#download-all { width: 144px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <h1 class="sidebar__title">Figma 2 Dezerv</h1>
        <label for="dataset-select" class="sr-only">Dataset</label>
        <select id="dataset-select" class="sidebar__select" style="top: 71px">
          <option value="colors" selected>Colors</option>
          <option value="text">Text</option>
        </select>
        <label for="mode-select" class="sr-only">Mode</label>
        <select id="mode-select" class="sidebar__select" style="top: 115px"></select>
      </aside>

      <main class="content">
        <section class="code">
          <pre class="code__pre" id="json-output">{}</pre>
        </section>
        <div class="actions">
          <button class="btn btn--secondary btn--download" id="download-all"><span>Download All</span></button>
          <button class="btn btn--secondary btn--download" id="download-current"><span>Download</span></button>
          <button class="btn btn--primary btn--copy" id="copy-current"><span>Copy</span></button>
        </div>
        <div class="toast" id="toast">Copied!</div>
      </main>
    </div>
    <script>
      var latest = null;        // colors
      var latestText = null;    // text
      var dataset = 'colors';
      var currentModeIndex = 0;

      function populateModeSelect() {
        var sel = document.getElementById('mode-select');
        while (sel.firstChild) sel.removeChild(sel.firstChild);

        let modes = [];
        if (dataset === 'text') {
          if (!latestText) { sel.style.display = 'none'; return; }
          modes = ['App','Desktop','Deck'];
        } else {
          if (!latest || !Array.isArray(latest.modes) || latest.modes.length === 0) { sel.style.display = 'none'; return; }
          modes = latest.modes;
        }

        modes.forEach((name, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          opt.textContent = name;
          if (idx === currentModeIndex) opt.selected = true;
          sel.appendChild(opt);
        });
        sel.style.display = '';
      }

      function renderMode(index) {
        currentModeIndex = Math.max(0, index || 0);
        let values = {};
        if (dataset === 'text') {
          const textModes = ['App','Desktop','Deck'];
          const mode = textModes[currentModeIndex];
          values = latestText?.values?.[mode] || {};
        } else {
          const modeName = latest.modes?.[currentModeIndex] || 'mode';
          values = latest?.values?.[modeName] || {};
        }

        const pre = document.getElementById('json-output');
        try {
          pre.textContent = JSON.stringify(values, null, 2);
        } catch(e) {
          pre.textContent = '{"error":"Failed to render variables"}';
        }
      }

      document.getElementById('dataset-select').addEventListener('change', e => {
        dataset = e.target.value;
        renderMode(currentModeIndex);
        populateModeSelect();
      });

      document.getElementById('mode-select').addEventListener('change', e => {
        const idx = parseInt(e.target.value, 10);
        if (!isNaN(idx)) currentModeIndex = idx;
        renderMode(currentModeIndex);
      });

      function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg || 'Copied!';
        t.classList.add('toast--show');
        setTimeout(() => t.classList.remove('toast--show'), 1200);
      }

      document.getElementById('copy-current').addEventListener('click', () => {
        const pre = document.getElementById('json-output');
        const text = pre.textContent || '';
        navigator.clipboard?.writeText(text).then(() => showToast('Copied!'), () => showToast('Copy failed'));
      });

      function download(filename, text) {
        const blob = new Blob([text], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 0);
      }

      document.getElementById('download-current').addEventListener('click', () => {
        if (dataset === 'text') {
          const mode = ['App','Desktop','Deck'][currentModeIndex];
          const payload = latestText?.values?.[mode] || {};
          download(`${mode}.json`, JSON.stringify(payload, null, 2));
        } else {
          const modeName = latest.modes?.[currentModeIndex] || 'mode';
          const payload = latest?.values?.[modeName] || {};
          download(`${modeName}.json`, JSON.stringify(payload, null, 2));
        }
      });

      document.getElementById('download-all').addEventListener('click', () => {
        const zip = new JSZip();
        if (dataset === 'text') {
          ['App','Desktop','Deck'].forEach(mode => {
            const payload = latestText?.values?.[mode] || {};
            zip.file(`${mode}.json`, JSON.stringify(payload, null, 2));
          });
        } else {
          latest?.modes?.forEach(mode => {
            const payload = latest.values?.[mode] || {};
            zip.file(`${mode}.json`, JSON.stringify(payload, null, 2));
          });
        }
        zip.generateAsync({ type: 'blob' }).then(content => {
          const a = document.createElement('a');
          const url = URL.createObjectURL(content);
          a.href = url; a.download = dataset === 'text' ? 'figma2dezerv-text.zip' : 'figma2dezerv-colors.zip';
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 0);
        });
      });

      window.onmessage = function(event) {
        const msg = event.data.pluginMessage;
        if (!msg) return;
        if (msg.type === 'vars') {
          latest = msg.payload || {};
          populateModeSelect();
          renderMode(currentModeIndex);
        }
        if (msg.type === 'textVars') {
          latestText = msg.payload || {};
          if (dataset === 'text') {
            populateModeSelect();
            renderMode(currentModeIndex);
          }
        }
      };
    </script>
  </body>
</html>
